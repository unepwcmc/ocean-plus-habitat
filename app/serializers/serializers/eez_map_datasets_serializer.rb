DATASETS = [
  {
    id: 'coralreefs',
    sourceLayers: [
      {
        type: 'poly',
        name: 'ProtectionCoralReef',
        sub_name: 'no-data',
        filter_id: 1,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionCoralReef',
        sub_name: '0-20',
        filter_id: 2,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionCoralReef',
        sub_name: '21-40',
        filter_id: 3,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionCoralReef',
        sub_name: '41-60',
        filter_id: 4,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionCoralReef',
        sub_name: '61-80',
        filter_id: 5,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionCoralReef',
        sub_name: '81-100',
        filter_id: 6,
        color: '#000000'
      }
    ],
    tilesUrl: 'https://data-gis.unep-wcmc.org/server/rest/services/Hosted/Coral_Reef_Projection/VectorTileServer/tile/{z}/{y}/{x}.pbf',
    color: '#F35F8D'
  },
  {
    id: 'saltmarshes',
    sourceLayers: [
      {
        type: 'poly',
        name: 'ProtectionSaltmarsh',
        sub_name: 'no-data',
        filter_id: 1,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionSaltmarsh',
        sub_name: '0-20',
        filter_id: 2,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionSaltmarsh',
        sub_name: '21-40',
        filter_id: 3,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionSaltmarsh',
        sub_name: '41-60',
        filter_id: 4,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionSaltmarsh',
        sub_name: '61-80',
        filter_id: 5,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionSaltmarsh',
        sub_name: '81-100',
        filter_id: 6,
        color: '#000000'
      }
    ],
    tilesUrl: 'https://data-gis.unep-wcmc.org/server/rest/services/Hosted/Saltmarsh_Projection/VectorTileServer/tile/{z}/{y}/{x}.pbf',
    color: '#332288'
  },
  {
    id: 'mangroves',
    sourceLayers: [
      {
        type: 'poly',
        name: 'ProtectionMangroves',
        sub_name: 'no-data',
        filter_id: 1,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionMangroves',
        sub_name: '0-20',
        filter_id: 2,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionMangroves',
        sub_name: '21-40',
        filter_id: 3,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionMangroves',
        sub_name: '41-60',
        filter_id: 4,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionMangroves',
        sub_name: '61-80',
        filter_id: 5,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionMangroves',
        sub_name: '81-100',
        filter_id: 6,
        color: '#000000'
      }
    ],
    tilesUrl: 'https://data-gis.unep-wcmc.org/server/rest/services/Hosted/Mangrove_Projection/VectorTileServer/tile/{z}/{y}/{x}.pbf',
    color: '#D6A520'
  },
  {
    id: 'seagrasses',
    sourceLayers: [
      {
        type: 'poly',
        name: 'ProtectionSeagrasses',
        sub_name: 'no-data',
        filter_id: 1,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionSeagrasses',
        sub_name: '0-20',
        filter_id: 2,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionSeagrasses',
        sub_name: '21-40',
        filter_id: 3,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionSeagrasses',
        sub_name: '41-60',
        filter_id: 4,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionSeagrasses',
        sub_name: '61-80',
        filter_id: 5,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionSeagrasses',
        sub_name: '81-100',
        filter_id: 6,
        color: '#000000'
      }
    ],
    tilesUrl: 'https://data-gis.unep-wcmc.org/server/rest/services/Hosted/Seagrass_Projection/VectorTileServer/tile/{z}/{y}/{x}.pbf',
    color: '#88CCEE',
  },
  {
    id: 'coldcorals',
    sourceLayers: [
      {
        type: 'poly',
        name: 'ProtectionColdCoral',
        sub_name: 'no-data',
        filter_id: 1,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionColdCoral',
        sub_name: '0-20',
        filter_id: 2,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionColdCoral',
        sub_name: '21-40',
        filter_id: 3,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionColdCoral',
        sub_name: '41-60',
        filter_id: 4,
        color: '#000000'
      },
      {
        type: 'poly',
        name: 'ProtectionColdCoral',
        sub_name: '61-80',
        filter_id: 5,
        color: '#332288'
      },
      {
        type: 'poly',
        name: 'ProtectionColdCoral',
        sub_name: '81-100',
        filter_id: 6,
        color: '#000000'
      }
    ],
    tilesUrl: 'https://data-gis.unep-wcmc.org/server/rest/services/Hosted/Cold_Coral_Projection/VectorTileServer/tile/{z}/{y}/{x}.pbf',
    color: '#E61354'
  }
].freeze

HABITATS_PRESENCE_STATUSES_DEFAULT = {
  coralreefs: 'present',
  saltmarshes: 'present',
  mangroves: 'present',
  seagrasses: 'present',
  coldcorals: 'present'
}.freeze

class Serializers::EezMapDatasetsSerializer < Serializers::Base
  include ApplicationHelper
  include ActionView::Helpers::NumberHelper

  def initialize(habitat_protection_stats, habitat_presence_statuses=HABITATS_PRESENCE_STATUSES_DEFAULT)
    super(habitat_presence_statuses, 'habitat_presence_statuses')
    super(habitat_protection_stats, 'habitat_protection_stats')
  end

  def serialize
    map_datasets = DATASETS.reject {|ds| habitat_presence_status(ds) == 'absent'}

    map_datasets.map do |ds|
      dataset = ds.dup
      dataset[:name] = get_habitat_from_id(ds[:id])[:title]
      dataset[:disabled] = habitat_presence_status(ds) == 'unknown' ? true : false
      set_dataset_description_html(dataset)

      dataset
    end
  end

  private

  def set_dataset_description_html dataset
    # TODO Adding nil check is a workaround so to avoid this to break until new data is imported
    if habitat_presence_status(dataset) == 'unknown' ||
        @habitat_protection_stats[dataset[:id]].nil?
      dataset[:descriptionHtml] = not_available_dataset_html
    else
      habitat_stats = @habitat_protection_stats[dataset[:id]]
      protected_percentage = habitat_stats['protected_percentage'].round(2)
      total_units = dataset[:id] == 'coldcorals' ? 'observations' : 'km<sup>2</sup>'
      total_value = number_with_precision(
        habitat_stats['total_value'],
        precision: total_units == 'observations' ? 0 : 2,
        delimiter: ','
      )

      dataset[:descriptionHtml] = I18n.t(
        'countries.shared.locations_map.filter_description_html',
        {
          habitat: dataset[:name],
          habitat_downcase: dataset[:name].downcase,
          total: "#{total_value} #{total_units}",
          percentage: protected_percentage.round(2),
        }
      )
    end
  end

  def habitat_presence_status dataset
    @habitat_presence_statuses[dataset[:id]]
  end

  def not_available_dataset_html
    "<p>#{I18n.t('global.map_not_available')}</p>"
  end
end
